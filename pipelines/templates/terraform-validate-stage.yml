# Validation stage template for Terraform
parameters:
  - name: environment
    type: string

steps:
- task: TerraformInstaller@0
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: '1.6.0'

- task: TerraformTaskV4@4
  displayName: 'Terraform Init'
  inputs:
    provider: 'azurerm'
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    backendServiceArm: 'Azure-Service-Connection'
    backendAzureRmResourceGroupName: $(TerraformBackendResourceGroupName)
    backendAzureRmStorageAccountName: $(TerraformBackendStorageAccountName)
    backendAzureRmContainerName: $(TerraformBackendContainerName)
    backendAzureRmKey: '$(environment).tfstate'

- task: TerraformTaskV4@4
  displayName: 'Terraform Validate'
  inputs:
    provider: 'azurerm'
    command: 'validate'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'

- bash: |
    terraform fmt -check -recursive
  displayName: 'Check Terraform Formatting'
  workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
