# Destroy stage template for Terraform
parameters:
  - name: environment
    type: string

steps:
- task: TerraformInstaller@0
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: '1.6.0'

- task: TerraformTaskV4@4
  displayName: 'Terraform Init'
  inputs:
    provider: 'azurerm'
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    backendServiceArm: 'Azure-Service-Connection'
    backendAzureRmResourceGroupName: $(TerraformBackendResourceGroupName)
    backendAzureRmStorageAccountName: $(TerraformBackendStorageAccountName)
    backendAzureRmContainerName: $(TerraformBackendContainerName)
    backendAzureRmKey: '$(environment).tfstate'

- task: TerraformTaskV4@4
  displayName: 'Terraform Destroy'
  inputs:
    provider: 'azurerm'
    command: 'destroy'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    environmentServiceNameAzureRM: 'Azure-Service-Connection'
    commandOptions: '-var-file="tfvars/$(environment).tfvars" -auto-approve'
