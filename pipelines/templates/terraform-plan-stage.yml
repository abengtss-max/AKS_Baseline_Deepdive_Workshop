# Plan stage template for Terraform
parameters:
  - name: environment
    type: string

steps:
- task: TerraformInstaller@0
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: '1.6.0'

- task: TerraformTaskV4@4
  displayName: 'Terraform Init'
  inputs:
    provider: 'azurerm'
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    backendServiceArm: 'Azure-Service-Connection'
    backendAzureRmResourceGroupName: $(TerraformBackendResourceGroupName)
    backendAzureRmStorageAccountName: $(TerraformBackendStorageAccountName)
    backendAzureRmContainerName: $(TerraformBackendContainerName)
    backendAzureRmKey: '$(environment).tfstate'

- task: TerraformTaskV4@4
  displayName: 'Terraform Plan'
  inputs:
    provider: 'azurerm'
    command: 'plan'
    workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    environmentServiceNameAzureRM: 'Azure-Service-Connection'
    commandOptions: '-var-file="tfvars/$(environment).tfvars" -out=tfplan'

- task: PublishPipelineArtifact@1
  displayName: 'Publish Plan'
  inputs:
    targetPath: '$(System.DefaultWorkingDirectory)/terraform/tfplan'
    artifact: 'tfplan-$(environment)'
